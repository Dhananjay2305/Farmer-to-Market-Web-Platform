<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Farmer Dashboard - Manage your produce listings and offers">
    <title>Farmer Dashboard - FarmDirect</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="index.html" class="sidebar__logo">
                üåæ FarmDirect
            </a>
            <nav>
                <ul class="sidebar__nav">
                    <li><a href="#" class="sidebar__link active" data-section="listings">üì¶ My Listings</a></li>
                    <li><a href="#" class="sidebar__link" data-section="offers">üí∞ Offers Received</a></li>
                    <li><a href="#" class="sidebar__link" data-section="add">‚ûï Add Listing</a></li>
                </ul>
            </nav>
            <div style="position: absolute; bottom: 2rem; left: 1.5rem; right: 1.5rem;">
                <div
                    style="padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 0.75rem; margin-bottom: 1rem;">
                    <p style="color: var(--gray-400); font-size: 0.875rem;">Logged in as</p>
                    <p style="color: white; font-weight: 600;" id="userName">Farmer</p>
                </div>
                <button onclick="logout()" class="btn btn--secondary btn--full"
                    style="color: var(--gray-300); border-color: var(--gray-600);">
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- My Listings Section -->
            <section id="listingsSection">
                <div class="page-header">
                    <h1 class="page-title">My Listings</h1>
                    <button class="btn btn--primary" onclick="showSection('add')">‚ûï Add New Listing</button>
                </div>
                <div class="listings-grid" id="myListingsGrid">
                    <!-- Listings will be loaded here -->
                    <div class="empty-state">
                        <div class="empty-state__icon">üì¶</div>
                        <h3 class="empty-state__title">No listings yet</h3>
                        <p class="empty-state__text">Start by adding your first produce listing</p>
                        <button class="btn btn--primary" onclick="showSection('add')">Add Listing</button>
                    </div>
                </div>
            </section>

            <!-- Offers Section -->
            <section id="offersSection" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">Offers Received</h1>
                </div>
                <div style="background: white; border-radius: var(--radius-xl); overflow: hidden;">
                    <table class="offers-table" id="offersTable">
                        <thead>
                            <tr>
                                <th>Crop</th>
                                <th>Buyer</th>
                                <th>Your Price</th>
                                <th>Offer Price</th>
                                <th>Message</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="offersTableBody">
                            <!-- Offers will be loaded here -->
                        </tbody>
                    </table>
                    <div class="empty-state" id="noOffersMessage" style="display: none;">
                        <div class="empty-state__icon">üí∞</div>
                        <h3 class="empty-state__title">No offers yet</h3>
                        <p class="empty-state__text">Offers from buyers will appear here</p>
                    </div>
                </div>
            </section>

            <!-- Add Listing Section -->
            <section id="addSection" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">Add New Listing</h1>
                </div>
                <div class="card" style="max-width: 600px; padding: 2rem;">
                    <form id="addListingForm">
                        <div class="form-group">
                            <label class="form-label">Crop Name *</label>
                            <input type="text" class="form-input" id="cropName"
                                placeholder="e.g., Tomatoes, Wheat, Rice" required>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Quantity *</label>
                                <input type="number" class="form-input" id="quantity" placeholder="Enter quantity"
                                    required min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Unit</label>
                                <select class="form-select" id="unit">
                                    <option value="kg">Kilograms (kg)</option>
                                    <option value="quintal">Quintal</option>
                                    <option value="ton">Ton</option>
                                    <option value="pieces">Pieces</option>
                                    <option value="dozen">Dozen</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Price per Unit (‚Çπ) *</label>
                            <input type="number" class="form-input" id="price" placeholder="Enter price per unit"
                                required min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location *</label>
                            <input type="text" class="form-input" id="location"
                                placeholder="Village/City, District, State" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-textarea" id="description"
                                placeholder="Add details about quality, harvest date, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Product Image</label>
                            <input type="file" class="form-input" id="image" accept="image/*">
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button type="submit" class="btn btn--primary btn--lg">
                                ‚úì Create Listing
                            </button>
                            <button type="button" class="btn btn--secondary btn--lg" onclick="showSection('listings')">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check authentication
        document.addEventListener('DOMContentLoaded', () => {
            const user = getUser();
            if (!user || user.role !== 'farmer') {
                window.location.href = 'auth.html';
                return;
            }
            document.getElementById('userName').textContent = user.name;
            loadMyListings();
            loadOffers();
        });

        // Navigation
        document.querySelectorAll('.sidebar__link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.dataset.section;
                showSection(section);
            });
        });

        function showSection(sectionName) {
            document.querySelectorAll('.sidebar__link').forEach(l => l.classList.remove('active'));
            document.querySelector(`[data-section="${sectionName}"]`)?.classList.add('active');

            document.getElementById('listingsSection').style.display = sectionName === 'listings' ? 'block' : 'none';
            document.getElementById('offersSection').style.display = sectionName === 'offers' ? 'block' : 'none';
            document.getElementById('addSection').style.display = sectionName === 'add' ? 'block' : 'none';
        }

        // Load farmer's listings
        async function loadMyListings() {
            try {
                const response = await api.get('/listings/my/listings');
                const listings = response.listings || [];
                const grid = document.getElementById('myListingsGrid');

                if (listings.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state__icon">üì¶</div>
                            <h3 class="empty-state__title">No listings yet</h3>
                            <p class="empty-state__text">Start by adding your first produce listing</p>
                            <button class="btn btn--primary" onclick="showSection('add')">Add Listing</button>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = listings.map(listing => `
                    <div class="card">
                        <img src="${listing.image || 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=200&fit=crop'}" 
                             alt="${listing.cropName}" class="card__image">
                        <div class="card__content">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <h3 class="card__title">${listing.cropName}</h3>
                                <span class="badge badge--${listing.status}">${listing.status}</span>
                            </div>
                            <div class="card__meta">
                                üìç ${listing.location}
                            </div>
                            <p style="color: var(--gray-600); margin-bottom: 1rem;">
                                ${listing.quantity} ${listing.unit}
                            </p>
                            <div class="card__price">
                                ‚Çπ${listing.price} <span>per ${listing.unit}</span>
                            </div>
                            <div class="card__footer">
                                <button class="btn btn--secondary btn--sm" onclick="toggleStatus('${listing._id}', '${listing.status}')">
                                    ${listing.status === 'available' ? '‚úì Mark Sold' : '‚Ü∫ Mark Available'}
                                </button>
                                <button class="btn btn--error btn--sm" onclick="deleteListing('${listing._id}')">
                                    üóë Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Load offers
        async function loadOffers() {
            try {
                const response = await api.get('/offers/received');
                const offers = response.offers || [];
                const tbody = document.getElementById('offersTableBody');
                const noOffersMsg = document.getElementById('noOffersMessage');
                const table = document.getElementById('offersTable');

                if (offers.length === 0) {
                    table.style.display = 'none';
                    noOffersMsg.style.display = 'block';
                    return;
                }

                table.style.display = 'table';
                noOffersMsg.style.display = 'none';

                tbody.innerHTML = offers.map(offer => `
                    <tr>
                        <td><strong>${offer.listingId?.cropName || 'N/A'}</strong></td>
                        <td>
                            ${offer.buyerId?.name || 'Unknown'}<br>
                            <small style="color: var(--gray-500);">${offer.buyerId?.phone || ''}</small>
                        </td>
                        <td>‚Çπ${offer.listingId?.price || 0}</td>
                        <td><strong style="color: var(--primary-600);">‚Çπ${offer.offerPrice}</strong></td>
                        <td style="max-width: 200px;">${offer.message || '-'}</td>
                        <td><span class="badge badge--${offer.status}">${offer.status}</span></td>
                        <td>
                            ${offer.status === 'pending' ? `
                                <div class="offers-table__actions">
                                    <button class="btn btn--success btn--sm" onclick="acceptOffer('${offer._id}')">‚úì Accept</button>
                                    <button class="btn btn--error btn--sm" onclick="rejectOffer('${offer._id}')">‚úó Reject</button>
                                </div>
                            ` : offer.status === 'accepted' ? `
                                <a href="https://wa.me/91${offer.buyerId?.phone}" target="_blank" class="btn btn--whatsapp btn--sm">
                                    WhatsApp
                                </a>
                            ` : '-'}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Add listing
        document.getElementById('addListingForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('cropName', document.getElementById('cropName').value);
            formData.append('quantity', document.getElementById('quantity').value);
            formData.append('unit', document.getElementById('unit').value);
            formData.append('price', document.getElementById('price').value);
            formData.append('location', document.getElementById('location').value);
            formData.append('description', document.getElementById('description').value);

            const imageFile = document.getElementById('image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            try {
                await api.postForm('/listings', formData);
                showToast('Listing created successfully!', 'success');
                e.target.reset();
                showSection('listings');
                loadMyListings();
            } catch (error) {
                showToast(error.message, 'error');
            }
        });

        // Toggle listing status
        async function toggleStatus(listingId, currentStatus) {
            const newStatus = currentStatus === 'available' ? 'sold' : 'available';
            try {
                await api.put(`/listings/${listingId}`, { status: newStatus });
                showToast(`Listing marked as ${newStatus}`, 'success');
                loadMyListings();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Delete listing
        async function deleteListing(listingId) {
            if (!confirm('Are you sure you want to delete this listing?')) return;
            try {
                await api.delete(`/listings/${listingId}`);
                showToast('Listing deleted', 'success');
                loadMyListings();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Accept offer
        async function acceptOffer(offerId) {
            try {
                await api.put(`/offers/${offerId}/accept`);
                showToast('Offer accepted! Listing marked as sold.', 'success');
                loadOffers();
                loadMyListings();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Reject offer
        async function rejectOffer(offerId) {
            try {
                await api.put(`/offers/${offerId}/reject`);
                showToast('Offer rejected', 'info');
                loadOffers();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }
    </script>
</body>

</html>